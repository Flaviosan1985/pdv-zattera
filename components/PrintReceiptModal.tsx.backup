// services/printService.ts
import { Order, StoreConfig } from '../types';

export const imprimirCupomExato = (order: Order, storeConfig: StoreConfig) => {
  const formatCurrency = (val: number) => {
    return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2 }).format(val);
  };

  const formatDate = (date: Date) => {
    return date.toLocaleString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  // Processar itens
  const processedItems = order.items.map(item => {
    let basePrice = 0;
    const isSmall = item.selectedSize === PizzaSize.SMALL;

    if (item.isHalfAndHalf) {
      const products = [item.product, item.secondProduct, item.thirdProduct].filter((p): p is typeof item.product => !!p);
      const prices = products.map(p => isSmall ? (p.priceSmall || (p.price * 0.8)) : p.price);
      basePrice = Math.max(...prices);
    } else {
      basePrice = isSmall ? (item.product.priceSmall || (item.product.price * 0.8)) : item.product.price;
    }

    let description = item.product.name;
    if (item.isHalfAndHalf) {
      description = `1/${item.thirdProduct ? '3' : '2'} ${item.product.name}`;
      if (item.secondProduct) description += ` + 1/${item.thirdProduct ? '3' : '2'} ${item.secondProduct.name}`;
      if (item.thirdProduct) description += ` + 1/3 ${item.thirdProduct.name}`;
    }

    if (item.selectedSize) {
      description += ` [${item.selectedSize === PizzaSize.SMALL ? 'BROTO' : 'GRANDE'}]`;
    }

    return {
      qtd: item.quantity,
      descricao: description.toUpperCase(),
      total: formatCurrency(basePrice * item.quantity)
    };
  });

  const totalPaid = order.payments?.reduce((acc, p) => acc + p.amount, 0) || 0;
  const change = order.changeNeeded || 0;

  const enderecoFormatado = order.address
    ? `${order.address.street}, ${order.address.number}${order.address.complement ? ' - ' + order.address.complement : ''} - ${order.address.neighborhood}, ${order.address.city}`
    : null;

  // GERAR HTML PURO - SEM REACT, SEM COMPONENTES
  const html = `
<!DOCTYPE html>
<html>
<head>
  <title>Cupom - ${storeConfig.name}</title>
  <meta charset="UTF-8">
  <style>
    /* RESET ABSOLUTO */
    * { margin: 0; padding: 0; border: 0; font-size: 100%; font: inherit; vertical-align: baseline; }
    
    /* CONFIG IMPRESSORA 80mm */
    @page { 
      size: 80mm auto; 
      margin: 0; 
    }
    
    body { 
      width: 80mm; 
      font-family: 'Courier New', Courier, monospace; 
      font-size: 10pt; 
      line-height: 1.0; 
      color: #000000; 
      background: white; 
      padding: 1mm 3mm; 
      margin: 0; 
      font-weight: bold; 
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    /* ESTILOS ESPECÍFICOS */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-bold { font-weight: bold; }
    .text-uppercase { text-transform: uppercase; }
    .mt-1 { margin-top: 1mm; }
    .mt-2 { margin-top: 2mm; }
    .mb-1 { margin-bottom: 1mm; }
    .mb-2 { margin-bottom: 2mm; }
    .py-1 { padding-top: 1mm; padding-bottom: 1mm; }
    .border-top { border-top: 1px solid #000; }
    .border-bottom { border-bottom: 1px solid #000; }
    .border-thick { border-top: 2px solid #000; border-bottom: 2px solid #000; }
    
    /* IMPRESSÃO */
    @media print {
      html, body {
        width: 80mm !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
  </style>
</head>
<body>
  <!-- CUPOM - TODO INLINE -->
  <div class="text-center text-uppercase mb-1" style="font-size: 13pt; font-weight: 900; border-bottom: 2px solid #000; padding-bottom: 1mm;">
    ${storeConfig.name.toUpperCase()}
  </div>
  
  <div class="text-center mb-2" style="font-size: 9pt; line-height: 1.1;">
    ${storeConfig.address}<br>
    CNPJ: ${storeConfig.cnpj}
  </div>
  
  <div style="height: 2px; background: #000; margin: 1mm 0 2mm 0;"></div>
  
  <!-- INFO PEDIDO -->
  <div style="display: flex; justify-content: space-between; font-weight: 900; font-size: 10pt; margin-bottom: 2mm;">
    <span>PEDIDO N°: ${order.id.slice(-4).toUpperCase()}</span>
    <span>${formatDate(order.date)}</span>
  </div>
  
  <!-- CLIENTE -->
  <div style="font-size: 10pt; margin-bottom: 2mm; padding: 1mm; background: #f0f0f0; border: 1px solid #ccc;">
    <div><strong>CLIENTE:</strong> ${order.customerName || 'VISITANTE'}</div>
    ${order.customerPhone ? `<div class="mt-1"><strong>TEL:</strong> ${order.customerPhone}</div>` : ''}
  </div>
  
  <!-- TIPO DE PEDIDO -->
  <div class="text-center text-uppercase py-1 mb-2" style="font-weight: 900; border: 1px dashed #000; font-size: 11pt;">
    ${order.orderType === 'DELIVERY' ? 'ENTREGA EM DOMICÍLIO' : 'RETIRADA NO LOCAL'}
  </div>
  
  <!-- ENDEREÇO SE HOUVER -->
  ${enderecoFormatado ? `
    <div style="font-size: 9pt; margin-bottom: 2mm; padding: 1mm; border: 1px solid #000;">
      <strong>ENDEREÇO:</strong><br>
      ${enderecoFormatado.toUpperCase()}
    </div>
  ` : ''}
  
  <div style="height: 1px; background: #000; margin: 2mm 0;"></div>
  
  <!-- CABEÇALHO ITENS -->
  <div style="display: grid; grid-template-columns: 15mm 1fr 18mm; font-weight: 900; font-size: 9pt; border-bottom: 2px solid #000; padding-bottom: 1mm; margin-bottom: 1mm;">
    <div>QTD</div>
    <div>DESCRIÇÃO</div>
    <div class="text-right">VALOR</div>
  </div>
  
  <!-- ITENS -->
  ${processedItems.map(item => `
    <div style="display: grid; grid-template-columns: 15mm 1fr 18mm; font-size: 9pt; margin-bottom: 1mm;">
      <div>${item.qtd}x</div>
      <div style="font-weight: 900;">${item.descricao}</div>
      <div class="text-right" style="font-weight: 900;">${item.total}</div>
    </div>
  `).join('')}
  
  <!-- TAXA ENTREGA -->
  ${order.deliveryFee > 0 ? `
    <div style="display: grid; grid-template-columns: 15mm 1fr 18mm; font-size: 9pt; margin-bottom: 1mm;">
      <div>1x</div>
      <div style="font-weight: 900;">TAXA DE ENTREGA</div>
      <div class="text-right" style="font-weight: 900;">${formatCurrency(order.deliveryFee)}</div>
    </div>
  ` : ''}
  
  <div style="height: 2px; background: #000; margin: 2mm 0;"></div>
  
  <!-- TOTAIS -->
  <div style="font-size: 10pt; margin-bottom: 2mm;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 1mm;">
      <span>SUBTOTAL:</span>
      <span><strong>${formatCurrency(order.subtotal)}</strong></span>
    </div>
    
    ${order.deliveryFee > 0 ? `
      <div style="display: flex; justify-content: space-between; margin-bottom: 1mm;">
        <span>TAXA ENTREGA:</span>
        <span><strong>${formatCurrency(order.deliveryFee)}</strong></span>
      </div>
    ` : ''}
    
    <div style="display: flex; justify-content: space-between; font-weight: 900; padding: 2mm 0; border-top: 2px solid #000; border-bottom: 2px solid #000; margin: 2mm 0; font-size: 11pt;">
      <span>VALOR A PAGAR:</span>
      <span>${formatCurrency(order.total)}</span>
    </div>
    
    <!-- PAGAMENTOS -->
    ${order.payments?.map(payment => `
      <div style="display: flex; justify-content: space-between; margin-bottom: 1mm;">
        <span>${payment.method === 'CASH' ? 'DINHEIRO' :
                 payment.method === 'PIX' ? 'PIX' :
                 payment.method === 'CREDIT_CARD' ? 'CARTÃO CRÉDITO' :
                 payment.method === 'DEBIT_CARD' ? 'CARTÃO DÉBITO' : payment.method}:</span>
        <span><strong>${formatCurrency(payment.amount)}</strong></span>
      </div>
    `).join('') || ''}
    
    <!-- TROCO -->
    ${change > 0 ? `
      <div style="display: flex; justify-content: space-between; font-weight: 900; margin-top: 2mm; padding-top: 2mm; border-top: 1px solid #000;">
        <span>TROCO:</span>
        <span>${formatCurrency(change)}</span>
      </div>
    ` : ''}
  </div>
  
  <div style="height: 2px; background: #000; margin: 2mm 0;"></div>
  
  <!-- RODAPÉ -->
  <div class="text-center text-uppercase py-1 mb-1" style="font-weight: 900; border-top: 2px solid #000; border-bottom: 2px solid #000; font-size: 11pt;">
    OBRIGADO E VOLTE SEMPRE!
  </div>
  
  <div class="text-center" style="font-size: 8pt; color: #666;">
    ${formatDate(new Date())}<br>
    Cupom não fiscal
  </div>
  
  <script>
    // IMPRIME E FECHA AUTOMATICAMENTE
    (function() {
      // Pequeno delay para carregar estilos
      setTimeout(function() {
        window.print();
        
        // Fecha após 1 segundo (ajuste conforme necessário)
        setTimeout(function() {
          window.close();
        }, 1000);
      }, 100);
    })();
  </script>
</body>
</html>
  `;

  // ABRIR JANELA DE IMPRESSÃO
  const janelaImpressao = window.open('', '_blank', 'width=350,height=500');
  
  if (janelaImpressao) {
    janelaImpressao.document.open();
    janelaImpressao.document.write(html);
    janelaImpressao.document.close();
  } else {
    // Fallback: usar iframe
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    document.body.appendChild(iframe);
    
    const iframeDoc = iframe.contentWindow?.document || iframe.contentDocument;
    if (iframeDoc) {
      iframeDoc.open();
      iframeDoc.write(html);
      iframeDoc.close();
      
      iframe.onload = () => {
        iframe.contentWindow?.print();
        setTimeout(() => {
          document.body.removeChild(iframe);
        }, 2000);
      };
    }
  }
};

// Função auxiliar para imprimir teste rápido
export const testeImpressao = () => {
  const htmlTeste = `
<!DOCTYPE html>
<html>
<head>
  <title>Teste Impressão</title>
  <style>
    @page { size: 80mm auto; margin: 0; }
    body { 
      width: 80mm; 
      font-family: 'Courier New', monospace; 
      font-size: 10pt; 
      padding: 2mm 3mm; 
      margin: 0; 
    }
  </style>
</head>
<body>
  <div style="text-align: center; font-weight: bold; font-size: 12pt;">
    TESTE IMPRESSORA 80mm
  </div>
  <hr style="border-top: 1px solid #000; margin: 2mm 0;">
  <div>Data: ${new Date().toLocaleString()}</div>
  <div>Linha 1: 123456789012345678901234567890</div>
  <div>Linha 2: ABCDEFGHIJKLMNOPQRSTUVWXYZ</div>
  <hr style="border-top: 1px solid #000; margin: 2mm 0;">
  <div style="text-align: center;">FIM DO TESTE</div>
  
  <script>
    setTimeout(() => {
      window.print();
      setTimeout(() => window.close(), 500);
    }, 100);
  </script>
</body>
</html>
  `;

  const janela = window.open('', '_blank', 'width=300,height=400');
  if (janela) {
    janela.document.open();
    janela.document.write(htmlTeste);
    janela.document.close();
  }
};

export default PrintReceiptModal;
